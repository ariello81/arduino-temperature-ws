<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.js"></script>
	<style>
	table, th, td {
		text-align:center;
		margin-left:auto; 
		margin-right:auto; 
		border: 1px solid #999999;
		border-collapse: collapse;
		font-family:arial,tahoma,verdana;
		padding:10px;
	}
	</style>
</head>
<body>
<div style="position:relative; width:90vw">
	<table>
		<tr>
			<td colspan="3" style="font-weight:bolder;">Ostatnio zarejestrowane parametry:</td>
		</tr>
		<tr style="background-color:#eeaaee">
			<td>Kotłownia:</td>
			<td id="temp0" style="font-weight:bolder;"></td>
			<td id="date0"></td>
		</tr>
		<tr style="background-color:#aaeeee">
			<td>Piec:</td>
			<td id="temp1" style="font-weight:bolder;"></td>
			<td id="date1"></td>
		</tr>
		<tr style="background-color:#eeeeaa">
			<td>Dwór:</td>
			<td id="temp2" style="font-weight:bolder;"></td>
			<td id="date2"></td>
		</tr>
		<tr style="background-color:#bbbbbb">
			<td>Zapas węgla:</td>
			<td id="coalSupplyValue" style="font-weight:bolder;"></td>
			<td id="coalSupplyDate"></td>
		</tr>
	</table>
</div>
<br/>
<div style="position:relative; margin:auto; width:60vw; font-family:arial,tahoma,verdana;">
	Pokaż wykres: 
		<select id="chart_select">
		  <option value="hourly">Godzinowo</option>
		  <option value="daily">Dniowo</option>
		  <option value="monthly">Miesięcznie</option>
		  <option value="yearly">Rocznie</option>
		</select>
</div>
<br/>
<div id="last_day">Last day</div>
<div id="last_week">Last week</div>
<div id="last_month">Last month</div>
<div id="last_year">Last year</div>
<br/>
<div class="chart" style="position:relative; margin:auto; height:30vh; width:70vw">
	<canvas id="myChart"></canvas>
</div>
</body>

<script>
var timeFormat = 'YYYY-MM-DD h:mm:ss';
var apiUrlTemp = "http://arduino-temperature-ws.herokuapp.com/location";
var apiUrlCoal = "http://arduino-temperature-ws.herokuapp.com/coal-consumption/total";
var apiUrlCoalSupply = "http://arduino-temperature-ws.herokuapp.com/coal-supply";
var chartTitle = "Temperatura w pomieszczeniach";
var lastTemp0, lastTemp1, lastTemp2, lastDate0, lastDate1, lastDate2, temp0values, temp1values, temp2values; 
var coalHourValues, lastCoalHourValue, lastCoalHourDate, coalDayValues, lastCoalDayValue, lastCoalDayDate, coalMonthValues, lastCoalMonthValue, lastCoalMonthDate, coalYearValues, lastCoalYearValue, lastCoalYearDate;
var myChart;
var lastDay = formatDate(new Date(new Date().getTime() - (24 * 60 * 60 * 1000)));
var lastWeek = formatDate(new Date(new Date().getTime() - (7 * 24 * 60 * 60 * 1000)));
var lastMonth = formatDate(new Date(new Date().getTime() - (31 * 7 * 24 * 60 * 60 * 1000)));
var lastYear = formatDate(new Date(new Date().getTime() - (366 * 31 * 7 * 24 * 60 * 60 * 1000)));

 $("#chart_select").change(function () {
	myChart.destroy();
    if (this.value == 'hourly'){
		BuildChart(temp0values, temp1values, temp2values, coalHourValues, 'hour', 'YYYY-MM-DD HH:mm')
	}
	else if (this.value == 'daily'){
		BuildChart(temp0values, temp1values, temp2values, coalDayValues, 'day', 'YYYY-MM-DD')
	}
	else if (this.value == 'monthly'){
		BuildChart(temp0values, temp1values, temp2values, coalMonthValues, 'month', 'MMM YYYY')
	}
	else if (this.value == 'yearly'){
		BuildChart(temp0values, temp1values, temp2values, coalYearValues, 'year', 'YYYY')
	}
});

$( "#last_day" ).click(function() {
  var t0values = temp0values.filter(function(item) {
	  return item.x > lastDay;
	});
	  var t1values = temp1values.filter(function(item) {
	  return item.x > lastDay;
	});
	  var t2values = temp2values.filter(function(item) {
	  return item.x > lastDay;
	});
	var cvalues = coalHourValues.filter(function(item) {
	  return item.x > lastDay;
	});
	BuildChart(t0values, t1values, t2values, cvalues, 'hour', 'YYYY-MM-DD HH:mm')
});
$( "#last_week" ).click(function() {
  var t0values = temp0values.filter(function(item) {
	  return item.x > lastWeek;
	});
	  var t1values = temp1values.filter(function(item) {
	  return item.x > lastWeek;
	});
	  var t2values = temp2values.filter(function(item) {
	  return item.x > lastWeek;
	});
	var cvalues = coalDayValues.filter(function(item) {
	  return item.x > lastWeek;
	});
	BuildChart(t0values, t1values, t2values, cvalues, 'day', 'YYYY-MM-DD')
});
$( "#last_month" ).click(function() {
  var t0values = temp0values.filter(function(item) {
	  return item.x > lastMonth;
	});
	  var t1values = temp1values.filter(function(item) {
	  return item.x > lastMonth;
	});
	  var t2values = temp2values.filter(function(item) {
	  return item.x > lastMonth;
	});
	var cvalues = coalDayValues.filter(function(item) {
	  return item.x > lastMonth;
	});
	BuildChart(t0values, t1values, t2values, cvalues, 'day', 'YYYY-MM-DD')
});

function formatDate(d) {
     var month = '' + (d.getMonth() + 1),
         day = '' + d.getDate(),
         year = d.getFullYear(),
         hours = '' + d.getHours(),
         minutes = '' + d.getMinutes(),
         seconds = '' + d.getSeconds();

     if (month.length < 2) month = '0' + month;
     if (day.length < 2) day = '0' + day;
     if (hours.length < 2) hours = '0' + hours;
     if (minutes.length < 2) minutes = '0' + minutes;
     if (seconds.length < 2) seconds = '0' + seconds;

     return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
 }

function BuildChart(temp0values, temp1values, temp2values, coalValues, timeUnit, toolTipFormat) {
    var data = {
        datasets: [{
			label: 'kotlownia', // Name the series
			yAxisID: "temperature",
            data: temp0values,
			fill: false,
			borderColor: 'rgb(250, 0, 250)',
			borderWidth:1,
			pointRadius:'2'
		},
		{
            label: 'piec', // Name the series
			yAxisID: "temperature",
            data: temp1values,
			fill: false,
			borderColor: 'rgb(0, 250, 250)',
			borderWidth:1,
			pointRadius:'2'
		},
		{
			label: 'dwor', // Name the series
			yAxisID: "temperature",
            data: temp2values,
			fill: false,
			borderColor: 'rgb(250, 250, 0)',
			borderWidth:1,
			pointRadius:'2'
		}, 
		{
			label: 'spalanie', // Name the series
			yAxisID: "coal",
            data: coalValues,
			minBarLength: 5,
			backgroundColor: 'rgb(200, 200, 200)',
			borderColor: 'rgb(0, 0, 0)',
			borderWidth:1,
			pointRadius:'2'
		}
		]
    };

    var ctx = document.getElementById("myChart").getContext('2d');
		
    myChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
			animation: false,
            responsive: true, // Instruct chart js to respond nicely.
			title:      {
                display: true,
				fontSize: 24,
                text:    chartTitle
            },
            scales: {
                xAxes: [{
					type:       "time",
					time: {
					  tooltipFormat: toolTipFormat, 
					  unit: timeUnit,
					  displayFormats: {
						 hour: 'YYYY-MM-DD HH:mm'
					  }
					},
                    scaleLabel: {
                        display: true,
						fontSize: 16,
                        labelString: 'Data'
                    }
                }],
                yAxes: [{
					id: "temperature",
					position: "left",
                    scaleLabel: {
                        display: true,
						fontSize: 16,
                        labelString: 'Temperatura (w stopniach Celsjusza)'
                    }
                },
				{
					id: "coal",
					position: "right",
                    scaleLabel: {
                        display:     true,
						fontSize: 16,
                        labelString: 'Spalanie węgla (w kg)'
                    }
                }]
            },
        }
    });

    return myChart;
}


var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var json = JSON.parse(this.response);
		// Map json labels  back to values array		  
		temp0values = json[0].temperatures.map(function (e) {
			lastDate0 = json[0].temperatures[json[0].temperatures.length-1].x;
			lastTemp0 = json[0].temperatures[json[0].temperatures.length-1].y;
			date0.innerHTML = moment(lastDate0).format('YYYY-MM-DD HH:mm:ss');
			temp0.innerHTML = lastTemp0 + " &#176;C";
			return e;
		});
		temp1values = json[1].temperatures.map(function (e) {
			lastDate1 = json[1].temperatures[json[1].temperatures.length-1].x;
			lastTemp1 = json[1].temperatures[json[1].temperatures.length-1].y;
			date1.innerHTML = moment(lastDate1).format('YYYY-MM-DD HH:mm:ss');
			temp1.innerHTML = lastTemp1 + " &#176;C";
			return e;
		});
		temp2values = json[2].temperatures.map(function (e) {
			lastDate2 = json[2].temperatures[json[2].temperatures.length-1].x;
			lastTemp2 = json[2].temperatures[json[2].temperatures.length-1].y;
			date2.innerHTML = moment(lastDate2).format('YYYY-MM-DD HH:mm:ss');
			temp2.innerHTML = lastTemp2 + " &#176;C";
			return e;
		});
		
    }
  };
  xhttp.open("GET", apiUrlTemp, false);
  xhttp.send();
  
  var xhttpCoal = new XMLHttpRequest();
  xhttpCoal.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var json = JSON.parse(this.response);
		// Map json labels  back to values array		  
		coalHourValues = json[0].map(function (e) {			
			return e;
		});	
		coalDayValues = json[1].map(function (e) {			
			return e;
		});	
		coalMonthValues = json[2].map(function (e) {			
			return e;
		});	
		coalYearValues = json[3].map(function (e) {			
			return e;
		});	
    }
  };
  xhttpCoal.open("GET", apiUrlCoal, false);
  xhttpCoal.send();

  var xhttpCoalSupply = new XMLHttpRequest();
  xhttpCoalSupply.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        coalSupplyDate.innerHTML = formatDate(new Date());
		coalSupplyValue.innerHTML = (Math.round(this.response * 100) / 100).toFixed(3).replace('.',',') + " kg";
    }
  };
  xhttpCoalSupply.open("GET", apiUrlCoalSupply, false);
  xhttpCoalSupply.send();
  
	var t0values = temp0values.filter(function(item) {		
		return item.x > lastDay;
	});
	  var t1values = temp1values.filter(function(item) {
	  return item.x > lastDay;
	});
	  var t2values = temp2values.filter(function(item) {
	  return item.x > lastDay;
	});
	var cvalues = coalHourValues.filter(function(item) {
	  return item.x > lastDay;
	});
  
  BuildChart(t0values, t1values, t2values, cvalues, 'hour', 'YYYY-MM-DD HH:mm');
</script>
</html>